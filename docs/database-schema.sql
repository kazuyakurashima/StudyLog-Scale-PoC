-- ==========================================
-- studylog-next - „Éá„Éº„Çø„Éô„Éº„Çπ„Çπ„Ç≠„Éº„ÉûË®≠Ë®à
-- ==========================================
-- ‰ΩúÊàêÊó•: 2025Âπ¥1Êúà27Êó•
-- Ë¶Å‰ª∂ÂÆöÁæ©Êõ∏„Å´Âü∫„Å•„Åè„ÉÜ„Éº„Éñ„É´Ë®≠Ë®à

-- ==========================================
-- 1. Â≠¶ÁøíË®òÈå≤„ÉÜ„Éº„Éñ„É´ (study_records)
-- ==========================================

-- Â≠¶ÁøíË®òÈå≤„ÉÜ„Éº„Éñ„É´„ÅÆ‰ΩúÊàê
CREATE TABLE study_records (
  id BIGSERIAL PRIMARY KEY,
  date DATE NOT NULL DEFAULT CURRENT_DATE,
  subject VARCHAR(20) NOT NULL CHECK (subject IN ('aptitude', 'japanese', 'math', 'science', 'social')),
  questions_total INTEGER NOT NULL CHECK (questions_total >= 1 AND questions_total <= 100),
  questions_correct INTEGER NOT NULL CHECK (questions_correct >= 0),
  emotion VARCHAR(10) NOT NULL CHECK (emotion IN ('good', 'normal', 'hard')),
  comment TEXT CHECK (LENGTH(comment) <= 300),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  CONSTRAINT valid_correct_answers CHECK (questions_correct <= questions_total)
);

-- „ÉÜ„Éº„Éñ„É´„Å®„Ç´„É©„É†„ÅÆ„Ç≥„É°„É≥„Éà
COMMENT ON TABLE study_records IS 'Â≠¶ÁøíË®òÈå≤„Çí‰øùÂ≠ò„Åô„Çã„ÉÜ„Éº„Éñ„É´';
COMMENT ON COLUMN study_records.id IS 'Â≠¶ÁøíË®òÈå≤„ÅÆ‰∏ÄÊÑèË≠òÂà•Â≠ê';
COMMENT ON COLUMN study_records.date IS 'Â≠¶Áøí„Åó„ÅüÊó•‰ªò';
COMMENT ON COLUMN study_records.subject IS 'ÁßëÁõÆÔºàÈÅ©ÊÄß„ÄÅÂõΩË™û„ÄÅÁÆóÊï∞„ÄÅÁêÜÁßë„ÄÅÁ§æ‰ºöÔºâ';
COMMENT ON COLUMN study_records.questions_total IS 'ÂïèÈ°åÁ∑èÊï∞Ôºà1-100Ôºâ';
COMMENT ON COLUMN study_records.questions_correct IS 'Ê≠£Á≠îÊï∞';
COMMENT ON COLUMN study_records.emotion IS 'Â≠¶ÁøíÊôÇ„ÅÆÊÑüÊÉÖÔºàgood=„Çà„Åè„Åß„Åç„Åü„ÄÅnormal=ÊôÆÈÄö„ÄÅhard=Èõ£„Åó„Åã„Å£„ÅüÔºâ';
COMMENT ON COLUMN study_records.comment IS '‰∏ÄË®Ä„Ç≥„É°„É≥„ÉàÔºàÊúÄÂ§ß300ÊñáÂ≠óÔºâ';
COMMENT ON COLUMN study_records.created_at IS '‰ΩúÊàêÊó•ÊôÇ';
COMMENT ON COLUMN study_records.updated_at IS 'Êõ¥Êñ∞Êó•ÊôÇ';

-- „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàêÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©ÂåñÔºâ
CREATE INDEX idx_study_records_date ON study_records(date);
CREATE INDEX idx_study_records_subject ON study_records(subject);
CREATE INDEX idx_study_records_created_at ON study_records(created_at);
CREATE INDEX idx_study_records_date_subject ON study_records(date, subject);

-- ==========================================
-- 2. „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÉÜ„Éº„Éñ„É´ (feedbacks)
-- ==========================================

-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÉÜ„Éº„Éñ„É´„ÅÆ‰ΩúÊàê
CREATE TABLE feedbacks (
  id BIGSERIAL PRIMARY KEY,
  record_id BIGINT NOT NULL REFERENCES study_records(id) ON DELETE CASCADE,
  sender_type VARCHAR(20) NOT NULL CHECK (sender_type IN ('parent', 'teacher')),
  reaction_type VARCHAR(10) CHECK (reaction_type IN ('clap', 'thumbs', 'muscle')),
  message TEXT CHECK (LENGTH(message) <= 500),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  CONSTRAINT feedback_content_check CHECK (
    (reaction_type IS NOT NULL AND message IS NULL) OR
    (reaction_type IS NULL AND message IS NOT NULL) OR
    (reaction_type IS NOT NULL AND message IS NOT NULL)
  )
);

-- „ÉÜ„Éº„Éñ„É´„Å®„Ç´„É©„É†„ÅÆ„Ç≥„É°„É≥„Éà
COMMENT ON TABLE feedbacks IS 'Â≠¶ÁøíË®òÈå≤„Å´ÂØæ„Åô„Çã„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÂøúÊè¥„Éª„Ç≥„É°„É≥„ÉàÔºâ„Çí‰øùÂ≠ò„Åô„Çã„ÉÜ„Éº„Éñ„É´';
COMMENT ON COLUMN feedbacks.id IS '„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÆ‰∏ÄÊÑèË≠òÂà•Â≠ê';
COMMENT ON COLUMN feedbacks.record_id IS 'ÂØæÂøú„Åô„ÇãÂ≠¶ÁøíË®òÈå≤„ÅÆID';
COMMENT ON COLUMN feedbacks.sender_type IS '„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÈÄÅ‰ø°ËÄÖ„ÅÆÁ®ÆÂà•Ôºàparent=‰øùË≠∑ËÄÖ„ÄÅteacher=ÊåáÂ∞éËÄÖÔºâ';
COMMENT ON COLUMN feedbacks.reaction_type IS '„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÁ®ÆÂà•Ôºàclap=üëè„Åô„Åî„ÅÑ„ÄÅthumbs=üëç„ÅÑ„ÅÑ„Å≠„ÄÅmuscle=üí™È†ëÂºµ„Å£„Å¶Ôºâ';
COMMENT ON COLUMN feedbacks.message IS '„Ç≥„É°„É≥„ÉàÂÜÖÂÆπÔºàÊúÄÂ§ß500ÊñáÂ≠óÔºâ';
COMMENT ON COLUMN feedbacks.created_at IS '‰ΩúÊàêÊó•ÊôÇ';

-- „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
CREATE INDEX idx_feedbacks_record_id ON feedbacks(record_id);
CREATE INDEX idx_feedbacks_sender_type ON feedbacks(sender_type);
CREATE INDEX idx_feedbacks_created_at ON feedbacks(created_at);

-- ==========================================
-- 3. Ëá™ÂãïÊõ¥Êñ∞„Éà„É™„Ç¨„Éº
-- ==========================================

-- Êõ¥Êñ∞Êó•ÊôÇ„ÅÆËá™ÂãïÊõ¥Êñ∞Èñ¢Êï∞
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- study_records„ÉÜ„Éº„Éñ„É´„ÅÆÊõ¥Êñ∞Êó•ÊôÇËá™ÂãïÊõ¥Êñ∞„Éà„É™„Ç¨„Éº
CREATE TRIGGER update_study_records_updated_at 
    BEFORE UPDATE ON study_records 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- ==========================================
-- 4. Row Level Security (RLS) „Éù„É™„Ç∑„Éº
-- ==========================================

-- study_records„ÉÜ„Éº„Éñ„É´„ÅÆRLSÊúâÂäπÂåñ
ALTER TABLE study_records ENABLE ROW LEVEL SECURITY;

-- ÂÖ®„É¶„Éº„Ç∂„Éº„ÅåÂ≠¶ÁøíË®òÈå≤„ÇíË™≠„ÅøÂèñ„ÇäÂèØËÉΩÔºà„Ç∑„É≥„Éó„É´Ë™çË®º„ÅÆ„Åü„ÇÅÔºâ
CREATE POLICY "public_can_read_study_records" 
ON study_records FOR SELECT 
TO anon, authenticated 
USING (true);

-- ÂÖ®„É¶„Éº„Ç∂„Éº„ÅåÂ≠¶ÁøíË®òÈå≤„ÇíÊåøÂÖ•ÂèØËÉΩ
CREATE POLICY "public_can_insert_study_records" 
ON study_records FOR INSERT 
TO anon, authenticated 
WITH CHECK (true);

-- ÂÖ®„É¶„Éº„Ç∂„Éº„ÅåÂ≠¶ÁøíË®òÈå≤„ÇíÊõ¥Êñ∞ÂèØËÉΩ
CREATE POLICY "public_can_update_study_records" 
ON study_records FOR UPDATE 
TO anon, authenticated 
USING (true) 
WITH CHECK (true);

-- feedbacks„ÉÜ„Éº„Éñ„É´„ÅÆRLSÊúâÂäπÂåñ
ALTER TABLE feedbacks ENABLE ROW LEVEL SECURITY;

-- ÂÖ®„É¶„Éº„Ç∂„Éº„Åå„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíË™≠„ÅøÂèñ„ÇäÂèØËÉΩ
CREATE POLICY "public_can_read_feedbacks" 
ON feedbacks FOR SELECT 
TO anon, authenticated 
USING (true);

-- ÂÖ®„É¶„Éº„Ç∂„Éº„Åå„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊåøÂÖ•ÂèØËÉΩ
CREATE POLICY "public_can_insert_feedbacks" 
ON feedbacks FOR INSERT 
TO anon, authenticated 
WITH CHECK (true);

-- ==========================================
-- 5. „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÊäïÂÖ•
-- ==========================================

-- Â≠¶ÁøíË®òÈå≤„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„Çø
INSERT INTO study_records (date, subject, questions_total, questions_correct, emotion, comment) VALUES
('2025-01-27', 'japanese', 20, 18, 'good', 'Êº¢Â≠ó„ÅåÈõ£„Åó„Åã„Å£„Åü„Åë„Å©È†ëÂºµ„Å£„Åü'),
('2025-01-27', 'math', 15, 12, 'normal', 'Ë®àÁÆóÂïèÈ°å„ÅØÂæóÊÑè„Å†„Å£„Åü'),
('2025-01-26', 'science', 25, 20, 'good', 'ÂÆüÈ®ì„ÅÆÂïèÈ°å„ÅåÈù¢ÁôΩ„Åã„Å£„Åü'),
('2025-01-26', 'social', 30, 24, 'hard', 'Âú∞ÁêÜ„ÅåÈõ£„Åó„ÅÑ'),
('2025-01-25', 'aptitude', 40, 35, 'good', 'ÈõÜ‰∏≠„Åó„Å¶Ëß£„Åë„Åü');

-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„Çø
INSERT INTO feedbacks (record_id, sender_type, reaction_type, message) VALUES
(1, 'parent', 'clap', '„Çà„ÅèÈ†ëÂºµ„Å£„Åü„Å≠ÔºÅÊº¢Â≠ó„ÅÆÁ∑¥Áøí„ÅÆÊàêÊûú„ÅåÂá∫„Å¶„Çã„Çà'),
(1, 'teacher', 'thumbs', 'È†ÜË™ø„Å†„Å≠„ÄÇ„Åì„ÅÆË™øÂ≠ê„ÅßÁ∂ö„Åë„Çà„ÅÜ'),
(2, 'parent', 'muscle', 'Ë®àÁÆóÂäõ„Åå„Å§„ÅÑ„Å¶„Åç„ÅüÔºÅ'),
(3, 'teacher', 'clap', 'ÂÆüÈ®ìÂïèÈ°å„ÅÆÁêÜËß£„ÅåÊ∑±„Åæ„Å£„Å¶„Çã'),
(4, 'parent', NULL, 'Âú∞ÁêÜ„ÅØË¶ö„Åà„Çã„Åì„Å®„ÅåÂ§ö„ÅÑ„Åë„Å©„ÄÅ‰∏ÄÁ∑í„Å´Âú∞Âõ≥„ÇíË¶ã„Å™„Åå„ÇâË¶ö„Åà„Çà„ÅÜ');

-- ==========================================
-- 6. ‰æøÂà©„Å™„Éì„É•„Éº„ÅÆ‰ΩúÊàê
-- ==========================================

-- Â≠¶ÁøíË®òÈå≤„Å®„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÁµêÂêà„Åó„Åü„Éì„É•„Éº
CREATE VIEW study_records_with_feedback AS
SELECT 
    sr.id,
    sr.date,
    sr.subject,
    sr.questions_total,
    sr.questions_correct,
    ROUND((sr.questions_correct::NUMERIC / sr.questions_total::NUMERIC) * 100, 1) as accuracy_rate,
    sr.emotion,
    sr.comment,
    sr.created_at,
    COALESCE(f.feedback_count, 0) as feedback_count,
    COALESCE(f.latest_feedback, NULL) as latest_feedback
FROM study_records sr
LEFT JOIN (
    SELECT 
        record_id,
        COUNT(*) as feedback_count,
        MAX(created_at) as latest_feedback
    FROM feedbacks 
    GROUP BY record_id
) f ON sr.id = f.record_id
ORDER BY sr.created_at DESC;

-- ÁßëÁõÆÂà•Áµ±Ë®à„Éì„É•„Éº
CREATE VIEW subject_statistics AS
SELECT 
    subject,
    COUNT(*) as total_sessions,
    SUM(questions_total) as total_questions,
    SUM(questions_correct) as total_correct,
    ROUND(AVG((questions_correct::NUMERIC / questions_total::NUMERIC) * 100), 1) as avg_accuracy_rate,
    COUNT(CASE WHEN emotion = 'good' THEN 1 END) as good_sessions,
    COUNT(CASE WHEN emotion = 'normal' THEN 1 END) as normal_sessions,
    COUNT(CASE WHEN emotion = 'hard' THEN 1 END) as hard_sessions
FROM study_records 
GROUP BY subject
ORDER BY subject;

-- Êó•Âà•Áµ±Ë®à„Éì„É•„Éº
CREATE VIEW daily_statistics AS
SELECT 
    date,
    COUNT(*) as sessions_count,
    COUNT(DISTINCT subject) as subjects_studied,
    SUM(questions_total) as total_questions,
    SUM(questions_correct) as total_correct,
    ROUND(AVG((questions_correct::NUMERIC / questions_total::NUMERIC) * 100), 1) as avg_accuracy_rate
FROM study_records 
GROUP BY date
ORDER BY date DESC;

-- ==========================================
-- 7. ‰æøÂà©„Å™Èñ¢Êï∞
-- ==========================================

-- Á∂ôÁ∂öÊó•Êï∞„ÇíË®àÁÆó„Åô„ÇãÈñ¢Êï∞
CREATE OR REPLACE FUNCTION get_study_streak()
RETURNS INTEGER AS $$
DECLARE
    streak_count INTEGER := 0;
    current_date DATE;
    check_date DATE := CURRENT_DATE;
BEGIN
    -- ‰ªäÊó•„Åã„ÇâÈÅ°„Å£„Å¶ÈÄ£Á∂öÂ≠¶ÁøíÊó•Êï∞„Çí„Ç´„Ç¶„É≥„Éà
    LOOP
        SELECT COUNT(*) INTO current_date
        FROM study_records 
        WHERE date = check_date;
        
        IF current_date > 0 THEN
            streak_count := streak_count + 1;
            check_date := check_date - INTERVAL '1 day';
        ELSE
            EXIT;
        END IF;
    END LOOP;
    
    RETURN streak_count;
END;
$$ LANGUAGE plpgsql;

-- ÁßëÁõÆÂà•Ê≠£Á≠îÁéá„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
CREATE OR REPLACE FUNCTION get_subject_accuracy(subject_name VARCHAR(20))
RETURNS NUMERIC AS $$
DECLARE
    accuracy NUMERIC;
BEGIN
    SELECT ROUND(AVG((questions_correct::NUMERIC / questions_total::NUMERIC) * 100), 1)
    INTO accuracy
    FROM study_records 
    WHERE subject = subject_name;
    
    RETURN COALESCE(accuracy, 0);
END;
$$ LANGUAGE plpgsql;

-- ==========================================
-- „Çπ„Ç≠„Éº„Éû‰ΩúÊàêÂÆå‰∫Ü
-- ==========================================

-- ‰ΩúÊàê„Åó„Åü„ÉÜ„Éº„Éñ„É´„ÅÆÁ¢∫Ë™ç
SELECT 
    table_name,
    table_comment
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('study_records', 'feedbacks');

-- ‰ΩúÊàê„Åó„Åü„Éì„É•„Éº„ÅÆÁ¢∫Ë™ç  
SELECT 
    table_name as view_name
FROM information_schema.views 
WHERE table_schema = 'public'; 

ALTER TABLE study_records 
ADD COLUMN study_date DATE,
ADD COLUMN content_type VARCHAR(20) CHECK (content_type IN ('class', 'homework')),
ADD COLUMN attempt_number INTEGER DEFAULT 1; 